# Branch Protection & PR Workflow Guide

## Purpose
Establish a minimal, testnet-appropriate workflow that prevents direct pushes to `main`, enforces review, and preserves repository integrity while in beta.

## Recommended Settings (GitHub > Settings > Branches > Branch protection rules)
1. Protected Branch: `main`
2. Require a pull request before merging: ENABLE
   - Require approvals: 1 (increase to 2 post-team expansion)
   - Dismiss stale approvals on new commits: ENABLE
   - Require review from Code Owners (optional if CODEOWNERS added)
3. Require status checks to pass before merging: ENABLE
   - Required checks: `CI (ubuntu-latest / Python 3.12)`, `CI (windows-latest / Python 3.12)`, `lint`, `codeql`
   - Optionally add coverage threshold checks later.
4. Require branches to be up to date before merging: ENABLE (prevents merging outdated PR base)
5. Require signed commits: OPTIONAL (enable if enforcing signature policy)
6. Require linear history: ENABLE (no merge commits; squash or rebase only)
7. Include administrators: ENABLE (ensures consistency)
8. Restrict who can push to matching branches: ENABLE (limit to release automation if needed)
9. Lock branch: DISABLED (still in active development)

## Pull Request Workflow
1. Create feature or fix branch: `feature/<short-topic>` or `chore/<task>`.
2. Implement changes with small logical commits.
3. Run local tests: `pytest -q` and lint: `flake8 src tests`.
4. Open PR targeting `main`; include concise summary, risk section, and test evidence.
5. Ensure required checks pass (CI matrix & lint). Fix issues before requesting review.
6. Reviewer validates:
   - No accidental inclusion of deferred modules from `src/_deferred/`.
   - No secrets or wallet data artifacts.
   - Feature flags respected for experimental code.
7. Merge strategy: **Squash** (recommended for beta) for clean history.

## Emergency Fix Protocol
For critical testnet breakages:
1. Branch `hotfix/<issue>` from `main`.
2. Minimal patch only; no feature additions.
3. PR with clear justification; expedite single approval.
4. Post-merge, create follow-up issue for root cause analysis.

## Release Tagging
1. Prepare release branch `release/v0.1.1-testnet`.
2. Update `src/VERSION.py`, `CHANGELOG.md`, create `docs/RELEASE_NOTE_<VERSION>.md`.
3. PR merge.
4. Tag: `git tag -a v0.1.1-testnet -m "0.1.1-testnet <focus>"; git push origin v0.1.1-testnet`.
5. GitHub Release auto-generated by workflow (see `.github/workflows/release.yml`).

## Deferred Feature Safeguards
Before enabling `ENABLE_WEB3_BROWSER` or `ENABLE_CALORIE_DB`:
1. Security review of dependencies & data flow.
2. Add tests ensuring no sensitive leakage.
3. Document activation rationale and rollback plan.
4. Enable flag ONLY via PR with explicit reviewer sign-off.

## Prohibited in PRs
| Action | Reason |
|--------|--------|
| Committing wallet seed/mnemonic | Security risk |
| Reintroducing removed backup files | Privacy breach |
| Activating deferred features silently | Undocumented surface expansion |
| Bypassing tests/lint with forced merges | Stability regression |

## Future Enhancements
- CODEOWNERS for security-sensitive paths.
- Coverage threshold enforcement (>70% for core modules).
- Secret scanning action on PR (GitHub Advanced Security or third-party).

## Testnet Disclaimer
All merges assume testnet-only operation; production deployment requires separate audit phase and explicit version bump out of `-testnet` suffix.
